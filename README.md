## Event Booking API

Production-ready NestJS + TypeORM service for reserving seats at events.

One user cannot book the same event twice; overbooking is prevented via transactional logic and row-level locking. The API is versioned, validated, rate-limited, and optionally documented via Swagger.

### Features

- Reserve a seat for an event: POST `/api/bookings/reserve`
- One booking per user per event (DB unique constraint)
- Seat capacity enforcement with transactional check and pessimistic locking
- Global validation and uniform error responses
- Rate limiting via Nest Throttler
- API versioning (URI), global prefix `/api`
- Swagger docs (optional): `/api/docs` when `ENABLE_SWAGGER=true`

### Tech Stack

- NestJS
- TypeORM (PostgreSQL)
- `typeorm-transactional`
- Swagger/OpenAPI

---

## Quick Start

### 1 Using Docker (recommended)

Prereqs: Docker, Docker Compose

```bash
cp docker.env.example docker.env
docker compose --env-file docker.env up --build
```

This starts Postgres and the API. The API listens on `API_PORT` (default 9000).

- API base: `http://localhost:9000/api`
- Swagger (if enabled): `http://localhost:9000/api/docs`

Stop:

```bash
docker compose down
```

### 2 Run locally (without Docker)

Prereqs: Node.js 18+, Yarn, PostgreSQL

1. Create `.env` from example and set values:

```bash
cp docker.env.example .env
```

Set at least:

- `API_PORT=9000`
- `ENABLE_SWAGGER=true` (optional)
- `DB_CONFIG.host=localhost`
- `DB_CONFIG.port=5432`
- `DB_CONFIG.username=postgres`
- `DB_CONFIG.password=postgres`
- `DB_CONFIG.database=booking_db`

2. Install deps and start:

```bash
yarn install
yarn start:dev
```

The app uses `synchronize: true` in development to auto-sync schema. Do not use in production.

---

## Configuration

Environment variables are loaded by Nest `ConfigModule` from `.env`.

- `API_PORT` – API port (default: `9000`)
- `ENABLE_SWAGGER` – set to `true` to expose `/api/docs`
- `DB_CONFIG.host` – PostgreSQL host
- `DB_CONFIG.port` – PostgreSQL port
- `DB_CONFIG.username` – PostgreSQL user
- `DB_CONFIG.password` – PostgreSQL password
- `DB_CONFIG.database` – PostgreSQL database

Global settings:

- Global prefix: `/api`
- Versioning: URI, default version `v1`
- Global validation pipe with detailed error formatting
- Global response interceptor and HTTP/TypeORM exception filters
- Global rate limiter (high defaults, tune for prod)

---

## Architecture & Conventions

- Layered by feature modules under `src/resources`, shared core under `src/core`
- Entities extend `BaseEntity` with `id` (uuid), `created_at`, `updated_at`
- DTOs use `class-validator` and `class-transformer` to map snake_case payloads
- Services contain transactional business logic
- Controllers are thin, annotated for Swagger

Key files:

- `src/resources/bookings` – controller, service, DTOs
- `src/core/entities` – `EventEntity`, `BookingEntity`, base entity
- `src/core/messages` – centralized error messages
- `src/core/filters`, `src/core/interceptors` – error handling & response shaping
- `src/main.ts` – app bootstrap, versioning, prefix, CORS, Swagger

---

## Database Schema

Auto-generated by TypeORM in development.

- `event`
  - `id` (uuid, PK)
  - `name` (varchar)
  - `total_seats` (int)
  - `created_at`, `updated_at`

- `bookings`
  - `id` (uuid, PK)
  - `event_id` (uuid, FK → `event.id`)
  - `user_id` (varchar)
  - `created_at`, `updated_at`
  - Unique constraint on `(event_id, user_id)`

Recommended indexes for scale:

- `bookings(user_id, event_id)`
- `bookings(event_id)`

---

## API

Base URL: `/api`

### Reserve a seat

POST `/api/bookings/reserve`

Request body:

```json
{
  "event_id": "071ee457-3f88-4612-8b56-f99dc30540eb",
  "user_id": "user123"
}
```

Responses:

- 201 Created – booking created
- 400 Bad Request – user already booked OR no seats available
- 404 Not Found – event not found

Example cURL:

```bash
curl -X POST http://localhost:9000/api/bookings/reserve \
  -H "Content-Type: application/json" \
  -d '{
    "event_id": "071ee457-3f88-4612-8b56-f99dc30540eb",
    "user_id": "user123"
  }'
```

Swagger UI (if enabled): `http://localhost:9000/api/docs`

---

## Validation & Error Handling

- Validation via global `ValidationPipe`; DTOs must specify constraints
- Error shape is normalized by global filters and response interceptor
- Common errors:
  - `err_event_not_found` – event does not exist
  - `err_user_already_booked_this_event` – duplicate booking
  - `err_no_seats_available` – capacity reached

---

## Transactions & Concurrency

- Reservation runs inside a DB transaction
- Duplicate check on `(event, user_id)`
- Pessimistic read lock applied during count to avoid overbooking under race
- DB-level unique constraint guarantees idempotency for duplicate POSTs

---

## Security & Hardening

- CORS enabled (configure origins for prod)
- Rate limiting via Nest Throttler (tune limits/TTL)
- Swagger should be disabled in public prod environments or protected
- Never use `synchronize: true` in production; use migrations

---

## Development

Scripts:

- `yarn start:dev` – run in watch mode
- `yarn build` – build the project
- `yarn start:prod` – start built app

Lint/format:

- `yarn lint`
- `yarn format`

---

## Production Checklist

- Disable TypeORM `synchronize`; add migrations and CI/CD steps
- Configure DB users, TLS, and restricted network access
- Set realistic throttling limits
- Observability: enable structured logging and metrics (e.g., Prometheus)
- Backups and restore procedure for the database
